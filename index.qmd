---
title: "Выборы в России из-за границы"
execute:
  echo: false 
  warning: false
subtitle: "Как голосуют на российских выборах граждане РФ проживающие за границей"
author: "Илья Тищенко"
fig-responsive: false
---

# Коротко

В 2020 году мне стало интересно, как проголосовала заграница на референдуме по изменению конституции. В результате, родилась [вот такая](https://rpubs.com/vearlen/obnulis "Результаты российского референдума 2020 года") короткая заметка. В 2024 прошли выборы в России. На основе данных собранных мной по заграничному голосованию в [Новой газете Европа](https://novayagazeta.eu/articles/2024/03/20/vosstanie-relokantov?fbclid=IwAR01A66cysVn84QduPZMTBjP3c1cIEfAVLW_drlLD7OGn7bNYmAMvk7sNck) вышла статья по участкам за границей. За что большое спасибо Алесе Соколовой, [подписывайтесь на её канал](https://t.me/research_for_democracy).

Тут кратко некоторые вещи, заинтересовавшие лично меня в процессе работы над данными, в дополнение к статье.

-   Выросла ли явка? Мы все видели огромные очереди в избирательные участки, многие люди не попали внутрь. Краткий ответ в абсолютных значениях - нет.

-   Какой "демографический" состав голосующих за рубежом? Почему на всех прошлых выборых за границей результат, за исключением 20-го и 24-го годов, в среднем выше чем официальный в России? В основном за счет военных или территорий контролируемых Россией, как ни странно и за границей есть вбросы.

-   Менялось ли как-то распределение голосующих от года к году и как? Менялось, в 2018 году на выборы пришел очень маленький процент людей голосующих против Путина, в 2024 году таких было сильно больше, а людей за Путина пришло меньше.

# Количество людей пришедших на голосование

```{r}
library(tidyverse)
library(plotly)
library(cowplot)
library(ggstar)
library(DT)
library('ggrepel')
library(modelsummary)
# options(scipen = 999)
RU04_24 <- read.csv("Data/RU04_24_Russia.csv")

# official results PU, ME, Referendum
pu <- tibble(year=c(2004,2008,2012,2018,2020, 2024),
             rat=c(71.3,70.28,63.6,76.7,78.45, 87),
             en_country = rep("Официальный результат 
выборов в РФ",6)) %>% 
  mutate(rat_dec = rat*0.01)
```

Как видно на @fig-total_voters общее абсолютное количество голосующих меньше чем в 2018 году, по-видимому, основная причина - закрытие участков для голосования.

```{r total voters function}
#| label: fig-total_voters
#| fig-cap: "Turnout abroad for Russian elections"

total_voters_fn <- function(sel_region = NA, sel_country = NA){
  if(is.na(sel_region)){
    sel_region = all_of(RU04_24$region)
    sel_region_label = NULL
  }  else {
    sel_region
    sel_region_label = sel_region
  }

  if(is.na(sel_country)){
    sel_country = all_of(RU04_24$en_country)
    sel_country_label = NULL
  } else {
    sel_country
    sel_country_label = sel_country
  }
#   
  total_voters <- RU04_24 %>% 
    filter(region %in% c(sel_region)) %>%
    filter(en_country %in% c(sel_country)) %>%
    filter(Label %in% c("Число недействительных избирательных бюллетеней",
                        "Число действительных избирательных бюллетеней","Ballots.in.box")) %>% 
    group_by(year) %>% 
    summarise(total = sum(number))
  
  g1 <- total_voters %>% 
    ggplot(aes(x=year,y=total))+
    geom_bar(position = 'stack',stat='identity', fill='#0084D7')+
    geom_text(aes(label=total,y=total*0.84),vjust = 1.5,color='grey99',size=3)+
    coord_flip()+
    theme_cowplot()+
    theme_minimal_vgrid(font_size = 9)+
    labs(y="",x="",fill="",title=paste0("Turnout abroad Russia ",sel_region_label,"  ",sel_country_label),
         subtitle= "")+
    scale_x_continuous(breaks = c(2024,2020,2018,2012,2008, 2004),
                       expand = expansion(0.1,0))+
    scale_y_continuous(labels = scales::comma,expand = expansion(0.01,0.2))+
    theme(legend.position = 'top',
          axis.line = element_blank(),
          axis.ticks.x = element_blank(),
          plot.subtitle = element_text(size=10,color='grey90',hjust=1),
          axis.ticks = element_blank())
  # g1
  ggplotly(g1)
}
total_voters_fn()
```

Тем не менее, как и многие я видел огромные очереди в избирательные участки в Вене, [Берлине](https://youtu.be/JmQw0TTWopU?si=JmhoYO32GIe0qt16), [Париже](https://www.youtube.com/live/FfY5mVx6Ir8?si=2w4nwVIF3_f40x3a&t=1688), Лондоне и [прочих](https://youtu.be/PdUrk4EEZUk?si=zWqv3t0ERDLsFteK) [городах](https://youtu.be/MMVJ-81B_h0?si=2CYBKrxQgn0TA_Xp). Как изменилась явка на зарубежных участках? На @fig-turnout по оси Х показано изменение явки в 2024 по сравнению с 2018, положительные значения - людей пришло больше 2024, размер точки - общее кол-во людей пришедших на участок.

```{r turnout_calc}
RU_total_UIK <- RU04_24 %>% 
  filter(Label %in% c("Число недействительных избирательных бюллетеней",
                      "Число действительных избирательных бюллетеней","Ballots.in.box")) %>% 
  group_by(UIK,year,en_country,Location) %>% 
  summarise(total = sum(number)) 

total_voters <- RU04_24 %>% 
  filter(Label %in% c("Число недействительных избирательных бюллетеней",
                      "Число действительных избирательных бюллетеней","Ballots.in.box")) %>% 
  group_by(UIK,year) %>% 
  summarise(total = sum(number))

gov_voters <- RU04_24 %>% 
  filter(Label %in% c("yes",
                      "Путин Владимир Владимирович",
                      "Медведев Дмитрий Анатольевич"
  )) %>%
  group_by(UIK,year) %>% 
  summarize(gov_total = sum(number))

reject_voters <- RU04_24 %>% 
  filter(Label %in% c("Rejected.ballots",
                      "Число недействительных избирательных бюллетеней")) %>% 
  group_by(UIK,year) %>% 
  summarize(reject_total = sum(number))

against_voters <- RU04_24 %>% 
  filter(Label %in% c("Глазьев Сергей Юрьевич",
                      "Против всех",
                      "Малышкин Олег Александрович",
                      "Миронов Сергей Михайлович",
                      "Хакамада Ирина Муцуовна",
                      "Харитонов Николай Михайлович",
                      "Богданов Андрей Владимирович",
                      "Жириновский Владимир Вольфович",
                      "Зюганов Геннадий Андреевич",
                      "Прохоров Михаил Дмитриевич",
                      "Бабурин Сергей Николаевич",
                      "Грудинин Павел Николаевич",
                      "Собчак Ксения Анатольевна",
                      "Сурайкин Максим Александрович",
                      "Титов Борис Юрьевич",
                      "Явлинский Григорий Алексеевич",
                      "Даванков Владислав Андреевич",
                      "Слуцкий Леонид Эдуардович",
                      "Харитонов Николай Михайлович",
                      "no")) %>% 
  group_by(UIK,year) %>% 
  summarize(against_total = sum(number))


sum_voters <- total_voters %>% 
  left_join(gov_voters) %>% 
  left_join(reject_voters) %>% 
  left_join(against_voters) %>% 
  mutate(gov_ratio = gov_total/total,
         reject_ratio = reject_total/total,
         against_ratio = against_total/total) %>% 
  mutate(gov_flag = if_else(gov_ratio > 0.5, "Y","N"))

```

```{r turnout_fig}
#| label: fig-turnout
#| fig-cap: "Difference in turnout 2018 and 2024"
#| fig-height: 9
# 
# UIK_country_Loc_24 <- RU_total_UIK %>% 
#     filter(year %in% c(2024)) %>% 
#     mutate(Location = str_trim(Location)) %>%
#     distinct(UIK,en_country,Location)



df_turnout_18_24 <- 
RU_total_UIK %>% 
  filter(year %in% c(2018, 2024)) %>% 
  mutate(Location = str_trim(Location)) %>%
  # rows_patch(UIK_country_Loc_24,by=c("UIK",'en_country')) %>% 
  pivot_wider(id_cols = c(UIK,en_country,Location),
              names_from = year,values_from = total) %>% 
  mutate(diff = `2024`- `2018`, ratio = round(diff/`2018`*100,0)) %>% 
  filter(!is.na(`2024`)) %>%
  left_join(filter(sum_voters,year==2024)) %>% 
  mutate(Location = if_else(is.na(Location),paste0(en_country,'-',as.character(UIK)),Location)) %>% 
  arrange(Location) %>% 
  ungroup() %>% 
  mutate(Location_Y = if_else(Location == lag(Location),paste0(Location,'-',as.character(UIK)),Location)) %>% 
  mutate(Location_Y = if_else(is.na(Location_Y),Location,Location_Y))
  

pal <- c('brown','#0084D7')
pal <- setNames(pal,c('Y','N'))
p <-
  plot_ly(
    df_turnout_18_24 %>% 
      filter(!is.na(ratio)),
    y = ~ reorder(Location_Y, -ratio),
    x = ~ ratio,
    size = ~ `2024`,
    alpha = 0.6,
    color = ~ gov_flag,
    colors=pal,
    text = ~paste("Country: ",en_country,
                  '<br>Location: ', Location_Y,'/',UIK,
                  '<br>Turnout',
                  '<br>  \'18:',`2018`,
                  '<br>  \'24:',`2024` ,
                  '<br>Difference: ', ratio,
                  '%<br>for Putin: ',round(gov_ratio*100,0),'%'),
    hoverinfo = 'text'
  ) %>% 
  add_markers(sizes = c(30,1000))

p %>% layout(yaxis=list(title=""),xaxis=list(title="Difference in turnout 2018-2024, %"),legend = list(orientation = 'h',title = list(text = "Putin won?"),y = 1,x=0.2))
```

```{r sum_ratio_calc}
total_sum <- total_voters %>% group_by(year) %>% summarize(sum = sum(total))
total_gov <- gov_voters %>% group_by(year) %>% summarise(sum_gov = sum(gov_total))

df_fake <- df_turnout_18_24 %>%
  filter(ratio > 506) %>%
  distinct(UIK) %>%
  left_join(gov_voters) %>%
  left_join(sum_voters) %>%
  filter(year==2024) %>% 
  left_join(total_sum) %>% 
  left_join(total_gov) %>% 
  mutate(ratio_total = total/sum,ratio_gov = gov_total/sum_gov) %>% 
  select(UIK,ratio_total,ratio_gov) %>% 
  summarise(sum_ratio = sum(ratio_total),sum_ratio_gov = sum(ratio_gov))
```

В глаза бросаются пять участков справа: Анкара, Молдова, Бангладеш, Кипр и Египет. В них положительная разница в явке более 500%. Суммарно эти участки дают `r round(df_fake$sum_ratio*100,0)` % всех голосов.

Пропускная способность в Зальцбурге была `r round(1437/13/3,0)` человека на одного человека в комисии в час, в Вене `r round(2278/13/6,0)`. Если предположить что скорость в Зальцбурге нормальная, то по количеству проголосовавших людей можно предположить где могли произойти вбросы. На @fig-cum_ratio показаны участки составляющие 60% всех голосующих.

```{r cum_ratio}
#| label: fig-cum_ratio
#| fig-cap: "Locations with 60% contribution to total voters"
#| fig-height: 6
#| 
df_cum_18_24 <- df_turnout_18_24 %>% 
  arrange(-total) %>% 
  mutate(cum_total = cumsum(total)) %>% 
  mutate(cum_ratio = cum_total/380724,ratio = total/380724) 


cum_75plot <-  function(el_year=2024,limit_ratio = 0.75){
  g1 <- df_cum_18_24 %>%
    filter(cum_ratio <= limit_ratio) %>%
    filter(year == el_year) %>%
    ggplot(aes(
      text = paste0(
        "Country: ",
        en_country,
        "<br>People voted: ",
        total,
        "<br>From all: ",
        round(ratio*100, 1),
        "%",
        "<br>Cumulative: ",
        round(cum_ratio * 100, 1),
        "%",
        "<br>Putin result: ",
        round(gov_ratio * 100, 0),
        "%"
      )
    )) +
    geom_col(aes(
      y = ratio,
      x = reorder(Location_Y, -ratio),
      fill = gov_flag
    )) +
    geom_line(
      aes(
        y = cum_ratio,
        group = 1,
        x = reorder(Location_Y, -ratio)
      ),
      color = 'grey20',
      linewidth = 0.1
    ) +
    geom_point(
      aes(y = cum_ratio, x = reorder(Location_Y, -ratio)),
      color = 'grey20',
      size = 1.5,
      alpha = 0.6
    ) +
    theme_minimal_hgrid() +
    labs(y = "Percent from all voters", 
         x = "", 
         title = "Locations with total amount of 60% from all voters",
         fill = "Putin won?") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       expand = expansion(0.01, 0)) +
    theme(
      axis.text.x = element_text(
        angle = 90,
        size = 9,
        color = 'grey40'
      ),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      axis.text.y = element_text(size = 9, color = 'grey40'),
      title = element_text(size = 12, color = 'grey20'),
      axis.title = element_text(size = 10, color = 'grey30')
    )
         

ggplotly(g1,tooltip = 'text')
}
cum_75plot(limit_ratio = 0.6)

```

# Демографический состав голосующих

Среди избирателей за рубежом очень много военных частей или контролируемых Россией квазигосударств (Абхазия, Приднестровье), их результат на выборых обычно предсказуемо выше 70%.

```{r military_calc}

RU_Pro_flag <- RU04_24 %>%
  distinct(UIK,year,Location,country,en_country) %>%
  mutate(Location = str_trim(Location)) %>%
  mutate(ru_pro = case_when(
    str_detect(Location,
  'Миноб|ФСБ|батальон|ОКРМС|штаб|в/ч|Матросский|офицеров|ОШК|ДОФ|КСПМ|Батальон|Клуб 1472')~'Military',
    str_detect(country,'Молда|Абха|Осет')~ "Military",
    UIK == 8027  ~ "Military",
    TRUE ~"Non military"))

RU04_24_PM <-
  RU04_24 %>% 
  filter(str_detect(Label,'Пу|Ме|yes')) %>% 
  group_by(UIK,Location,en_country,year,region) %>% 
  summarise(rat = mean(ratio), people = sum(number)) #%>%

df_mlt <- RU04_24_PM %>% 
  mutate(Location = str_trim(Location)) %>%
  left_join(RU_Pro_flag,by=join_by(UIK,year,Location,en_country)) %>%
  mutate(year = as.factor(year)) %>%
  arrange(year) %>%
  mutate(rat_bin = cut(rat,seq(0,100,by=5),right = TRUE)) %>% 
  group_by(year,rat_bin,ru_pro) %>% 
  summarise(people_bin = sum(people)) 
  
```

```{=html}
<iframe title="Russian elections, 2004" aria-label="Stacked Bars" id="datawrapper-chart-EUK0C" src="https://datawrapper.dwcdn.net/EUK0C/1/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="421" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
</script>
```
В 2018 есть подозрение, что какие-то военные части я не учел. В 2024 году интервал начиная с 85 и выше либо вбросы (Кипр) либо военные, что отражает последние выборы даже за рубежом.

```{r military_fig}
#| label: fig-military_fig
#| fig-cap: "Military controlled voters"
#| fig-height: 9
#| fig-align: 'left'
# g1 <- df_mlt %>%
#   ggplot(aes(
#     x = rat_bin,
#     fill = ru_pro,
#     text = paste0(
#       "Category: ",
#       rat_bin,
#       "<br>People: ",
#       people_bin,
#       "<br>",
#       ru_pro
#     )
#   )) +
#   geom_col(
#     aes(y = people_bin),
#     position = position_dodge2(preserve = 'single', padding = 0),
#     width = 0.7
#   ) +
#   scale_fill_manual(values = c('brown','#0084D7')) +
#   theme_minimal_hgrid(font_size = 10) +
#   facet_grid(year ~ .) +
#   labs(x = "votes for Putin %", y = "number of votes for Putin", fill =
#          "") +
#   scale_y_continuous(
#     breaks = c(0, 10000, 30000, 50000, 80000),
#     labels = c('0', '10K', '30k', '50K', '80K')
#   ) +
#   scale_x_discrete(
#     labels = c(
#       '10',
#       '',
#       '20',
#       '',
#       '30',
#       '',
#       '40',
#       '',
#       '50',
#       '',
#       '60',
#       '',
#       '70',
#       '',
#       '80',
#       '',
#       '90',
#       '',
#       '100'
#     )
#   ) +
#   theme(
#     legend.position = 'top',
#     axis.line = element_blank(),
#     panel.grid.major.y = element_line(
#       color = 'grey90',
#       linetype = 1,
#       linewidth = 0.01
#     ),
#     axis.title.y = element_text(margin = margin(0,20,0,0))
#   )
# 
# 
# 
# ggplotly(g1,tooltip = 'text',width = 800) %>% layout(legend=list(orientation='h',xanchor='center',x=0.5,y=1.05))
```

```{r}
#| fig-width: 7
#| fig-height: 9
# g1
```

У Важных историй получилось, что процент военных и квазигосударств [составляет 46%](https://istories.media/news/2024/03/18/bolee-46-golosov-za-putina-na-zarubezhnikh-territoriyakh-polucheno-v-podkontrolnikh-rossii-stranakh-i-voinskikh-chastyakh/), у меня вышло в районе 37% в 2024 @fig-mil_prop.

```{r mil_prop}
#| label: fig-mil_prop
#| fig-cap: "Military controlled voters, %"
g1 <- RU04_24_PM %>%
  mutate(Location = str_trim(Location)) %>%
  left_join(RU_Pro_flag,by=join_by(UIK,year,Location,en_country)) %>%
  group_by(year,ru_pro) %>%
  summarise(people = sum(people)) %>%
  pivot_wider(id_cols = year,names_from = ru_pro,values_from = people) %>%
  mutate(Y_N_ratio = `Military`/(`Military`+`Non military`)) %>% 
  ggplot()+
  geom_col(aes(x=year,y=Y_N_ratio),fill='brown')+
  geom_text(aes(x=year,label=paste0(round(Y_N_ratio*100,0),"%"),y=Y_N_ratio*0.92),vjust = 1.5,color='grey99')+
  theme_minimal_hgrid(font_size = 10)+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  labs(title="Military or controlled territories among voters abroad",x="",y="")+
  scale_x_continuous(breaks = c(2004,2008,2012,2018,2020,2024))+
  theme(axis.line = element_blank(),
        axis.ticks = element_blank())

g1
```

# Динамика голосования

Рассматривая данные с 2004 года, можно обратить внимание, что в 2012 было довольно много стран где результат Путина был ниже 50%. В 2018 таких стран не было, в 20-ом и 24-ом снова распределение стало более широким @fig-how_voted_gif

```{r}

RU04_24_PM <-
  RU04_24 %>% 
  filter(str_detect(Label,'Пу|Ме|yes')) %>% 
  group_by(en_country,year,region) %>% 
  summarise(rat = mean(ratio), people = sum(number))
```

[![Amount of people vs results for Putin](out/elec_04_24_country.gif){#fig-how_voted_gif fig-align="center"}](fig-how_voted_gif)

```{r fig non-animated}
#| label: fig-voted_putin
#| fig-cap: "Amount of people vs result for Putin"
#| 
# g1 <- RU04_24_PM %>%
#   ggplot(aes(x=people,y=rat,color=region,text=paste0(en_country,"<br>Votes: ",people,
#                                                      "<br>Putin: ",round(rat),"%")))+
#   geom_point(alpha = 0.7, size=2)+
#   scale_x_log10()+
#   theme_minimal(base_size = 10)+
#   panel_border()+
#   labs(title = "",
#        y = "votes for Putin, %",
#        x = "Amount of people, log scale",
#        color ="")+
#   facet_grid(~year)
# 
# ggplotly(g1,tooltip = 'text') %>% layout(legend = list(orientation='h'))
```

Особенностью этих выборов стало не увеличение явки, она не особо выросла, учитывая закрывшиеся участки, а то что количество про-Путинских избирателей стало меньше, а протестных избирателей пришло больше. Это видно как на общих данных так и на европейских.

```{r}
voters_total <- function(sel_region = NA, sel_country = NA, ratio=TRUE,plotly_plot = FALSE){
  
  if(is.na(sel_region)){
    sel_region = all_of(RU04_24$region)
    sel_region_label = "all regions"
      if(!is.na(sel_country)){sel_region_label = NULL}
  }  else {
    sel_region
    sel_region_label = sel_region
  }
  
  if(is.na(sel_country)){
    sel_country = all_of(RU04_24$en_country) 
    sel_country_label = NULL
  } else {
    sel_country
    sel_country_label = sel_country
  }  
  
  total_voters <- RU04_24 %>% 
    filter(region %in% c(sel_region)) %>% 
    filter(en_country %in% c(sel_country)) %>%
    filter(Label %in% c("Число недействительных избирательных бюллетеней",
                        "Число действительных избирательных бюллетеней","Ballots.in.box")) %>% 
    group_by(year) %>% 
    summarise(total = sum(number))
  
  
  
  gov_voters <- RU04_24 %>% 
    filter(region %in% c(sel_region)) %>%
    filter(en_country %in% c(sel_country)) %>%
    filter(Label %in% c("yes",
                        "Путин Владимир Владимирович",
                        "Медведев Дмитрий Анатольевич"
    )) %>%
    group_by(year) %>% 
    summarize(gov_total = sum(number))
  
  reject_voters <- RU04_24 %>% 
    filter(region == sel_region) %>%
    filter(en_country %in% c(sel_country)) %>%
    filter(Label %in% c("Rejected.ballots",
                        "Число недействительных избирательных бюллетеней")) %>% 
    group_by(year) %>% 
    summarize(reject_total = sum(number))
  
  against_voters <- RU04_24 %>% 
    filter(region %in% c(sel_region)) %>%
    filter(en_country %in% c(sel_country)) %>%
    filter(Label %in% c("Глазьев Сергей Юрьевич",
                        "Против всех",
                        "Малышкин Олег Александрович",
                        "Миронов Сергей Михайлович",
                        "Хакамада Ирина Муцуовна",
                        "Харитонов Николай Михайлович",
                        "Богданов Андрей Владимирович",
                        "Жириновский Владимир Вольфович",
                        "Зюганов Геннадий Андреевич",
                        "Прохоров Михаил Дмитриевич",
                        "Бабурин Сергей Николаевич",
                        "Грудинин Павел Николаевич",
                        "Собчак Ксения Анатольевна",
                        "Сурайкин Максим Александрович",
                        "Титов Борис Юрьевич",
                        "Явлинский Григорий Алексеевич",
                        "Даванков Владислав Андреевич",
                        "Слуцкий Леонид Эдуардович",
                        "Харитонов Николай Михайлович",
                        "no")) %>% 
    group_by(year) %>% 
    summarize(against_total = sum(number))
  
  
  sum_voters <- total_voters %>% 
    left_join(gov_voters) %>% 
    left_join(reject_voters) %>% 
    left_join(against_voters) %>% 
    mutate(gov_ratio = gov_total/total,
           reject_ratio = reject_total/total,
           against_ratio = against_total/total)
  
  
  
  sum_tmp <-  sum_voters %>% 
    select(year,gov_total,reject_total,against_total) %>% 
    pivot_longer(-year,names_to = "category",values_to = 'ratio') %>% 
    mutate(category = case_when(
      category == "gov_total" ~ "pro P",
      category == "against_total" ~ "against P",
      category == "reject_total" ~ "spoiled ballot",
      TRUE~category
    )) %>% 
    mutate(category = fct_relevel(category,'against P','spoiled ballot','pro P'))
  
pro_p_label <-
  sum_tmp %>% 
  filter(year != 2020) %>% 
  pivot_wider(id_cols = year,names_from = category,values_from = ratio) %>% 
  mutate(pro_p_label = `pro P` - dplyr::lag(`pro P`), 
         pro_p_x = (year - 1.5),
         pro_p_y = `pro P`,
         against_p_label = (`against P`+`spoiled ballot`) - 
                            (dplyr::lag(`spoiled ballot`)+dplyr::lag(`against P`)), 
         against_p_x = (year - 1.5),
         against_p_y = (`against P`+`pro P`+`spoiled ballot`)) %>% 
  mutate(seg_x = if_else(year>2004,year-1,NA),
         seg_xend = if_else(year>2004,year,NA)) %>% 
  rowwise() %>% 
  mutate(total = sum(`pro P`+`spoiled ballot`+`against P`)) %>% 
  mutate(pro_r = round(`pro P`/total,2),
         against_r = round(`against P`/total,2),
         spoiled_r = round(`spoiled ballot`/total,2)) %>% 
  mutate(mid_pro_y = `pro P`/2,
         mid_against_y = (`pro P`+`spoiled ballot` + `against P`)-(`against P`/2),
         mid_spoiled_y = (`pro P`+`spoiled ballot`)-(`spoiled ballot`/2))
  

# static plot with deltas
 g1 <-  sum_tmp %>% 
   filter(year != 2020) %>%
    ggplot()+
   geom_segment(
     data = pro_p_label,
     aes(
       x = seg_x,
       y = `pro P`,
       xend = seg_xend,
       yend = `pro P`
     ),
     color = 'brown',
     linewidth = 0.5
   ) +
   geom_segment(
     data = pro_p_label,
     aes(
       x = seg_x,
       y = against_p_y*0.99,
       xend = seg_xend,
       yend = against_p_y*0.99
     ),
     color = '#0084D7',
     linewidth = 0.5
   ) +
   geom_col(aes(x=year,y=ratio,fill=category), width = 0.8)+
    
    scale_fill_manual(values = c("pro P" = '#8c190f',
                                 "against P" = '#0084D7',
                                 "spoiled ballot" = '#005082'),
                      breaks = c("pro P",
                                 "against P",
                                 "spoiled ballot" ),
                      labels = c("pro P",
                                 "against P",
                                 "spoiled ballot" ))+
    theme_cowplot()+
    theme_minimal_hgrid()+
   # legends
   annotate(
     geom = 'text',
     x = 2020,
     y = pro_p_label$against_p_y[5]*1.26,
     label = "Year-Year difference
including spoiled",
     hjust=0,
     size=3.5,
     color='#0084D7'
   )+
   annotate(
     'curve',
     x = 2020, # Play around with the coordinates until you're satisfied
     y = pro_p_label$against_p_y[5]*1.16,
     yend = pro_p_label$against_p_y[5]*0.99,
     xend = 2021.6,
     linewidth = 0.3,
     color='#0084D7',
     curvature = 0.1,
     arrow = arrow(length = unit(0.1, 'cm'))
   )+
  # pro rus difference  
   geom_label(
     data = pro_p_label,
     aes(x = pro_p_x, y = pro_p_y, label = pro_p_label),
     fill = '#8c190f',
     color = 'white',
     vjust=1,
     size=3.5,
   )+
   # protest difference
   geom_label(
     data = pro_p_label,
     aes(x = against_p_x, y = against_p_y, label = against_p_label),
     fill = '#0084D7',
     color = 'white',
     vjust=1,
     size=3.5
   )+
   # total number
   geom_text(
     data = pro_p_label,
     aes(x = year, y = total, label = total),
     size = 4,
     color = 'grey50',
     vjust=-0.2
   )+
   # ratios
   geom_text(
     data = pro_p_label,
     aes(
       x = year,
       y = mid_pro_y,
       label = paste0(pro_r * 100, "%")
     ),
     angle = 90,
     size = 2.8,
     color = 'grey80'
   ) +
   geom_text(
     data = pro_p_label,
     aes(
       x = year,
       y = mid_against_y,
       label = ifelse(against_r < 0.05, '', paste0(against_r *
                                                     100, "%"))
     ),
     angle = 90,
     size = 2.8,
     color = 'grey80'
   ) +
   geom_text(
     data = pro_p_label,
     aes(
       x = year,
       y = mid_spoiled_y,
       label = ifelse(spoiled_r < 0.05, '', paste0(spoiled_r *
                                                     100, "%"))
     ),
     angle = 90,
     size = 2.8,
     color = 'grey80'
   ) +
   labs(y="people",x="",fill="",
         title=paste0("Russians voted in ",sel_region_label,"  ",sel_country_label))+
    theme(legend.position = 'top',
          axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.grid = element_line(color='grey70',linewidth = 0.1))+
          scale_x_continuous(breaks = c(2004,2008,2012,2018,2024))
    
 # g1
 
 g2 <- sum_tmp %>% 
    ggplot()+
    geom_bar(aes(x=year,
                 y=ratio,
                 fill=category), 
                 position = 'fill',
                 stat = 'identity'
                )+
    geom_point(data = pu,
               aes(x=year,y=rat_dec),
               size = 4,
               alpha = 0.9,
               color = 'yellow'
    ) +
    scale_fill_manual(values = c("pro P" = '#8c190f',
                                 "against P" = '#0084D7',
                                 "spoiled ballot" = '#005082'),
                      breaks = c("pro P",
                                 "against P",
                                 "spoiled ballot" ),
                      labels = c("pro P",
                                 "against P",
                                 "spoiled ballot" ))+
    theme_cowplot()+
    theme_minimal_hgrid()+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    labs(y="%",x="",fill="",title=paste0("Russians voted in ",sel_region_label," ",sel_country_label),
         subtitle="Official results, \"Russian\" official results with yellow dot")+
    theme(legend.position = 'top',
          axis.line.x = element_blank(),
          axis.ticks.x = element_blank())+
    scale_x_continuous(breaks = c(2004,2008,2012,2018,2020,2024))
  
if(ratio){ 
  if(plotly_plot){
  ggplotly(g2) %>%  
    plotly::layout(legend=list(x=0, 
                               xanchor='left',
                               yanchor='top',
                               orientation='h'))
    }else{g2}
  
}else{
  if(plotly_plot){ggplotly(g1) %>%  
    plotly::layout(legend=list(x=0, 
                               xanchor='left',
                               yanchor='top',
                               orientation='h'))
}else{g1}}
}

voters_total(ratio=FALSE)


```

```{r}
voters_total(sel_region = 'Europe',ratio=FALSE)
```

```{r}
# total_voters <- RU04_24 %>% 
# 
#   filter(Label %in% c("Число недействительных избирательных бюллетеней",
#                       "Число действительных избирательных бюллетеней","Ballots.in.box")) %>% 
#   group_by(year,en_country) %>% 
#   summarise(total = sum(number))
# 
# gov_voters <- RU04_24 %>% 
#   filter(Label %in% c("yes",
#                       "Путин Владимир Владимирович",
#                       "Медведев Дмитрий Анатольевич"
#   )) %>%
#   group_by(year,en_country) %>% 
#   summarize(gov_total = sum(number))
# 
# reject_voters <- RU04_24 %>% 
#   filter(Label %in% c("Rejected.ballots",
#                       "Число недействительных избирательных бюллетеней")) %>% 
#   group_by(year,en_country) %>% 
#   summarize(reject_total = sum(number))
# 
# against_voters <- RU04_24 %>% 
#   filter(Label %in% c("Глазьев Сергей Юрьевич",
#                       "Против всех",
#                       "Малышкин Олег Александрович",
#                       "Миронов Сергей Михайлович",
#                       "Хакамада Ирина Муцуовна",
#                       "Харитонов Николай Михайлович",
#                       "Богданов Андрей Владимирович",
#                       "Жириновский Владимир Вольфович",
#                       "Зюганов Геннадий Андреевич",
#                       "Прохоров Михаил Дмитриевич",
#                       "Бабурин Сергей Николаевич",
#                       "Грудинин Павел Николаевич",
#                       "Собчак Ксения Анатольевна",
#                       "Сурайкин Максим Александрович",
#                       "Титов Борис Юрьевич",
#                       "Явлинский Григорий Алексеевич",
#                       "Даванков Владислав Андреевич",
#                       "Слуцкий Леонид Эдуардович",
#                       "Харитонов Николай Михайлович",
#                       "no")) %>% 
#   group_by(year,en_country) %>% 
#   summarize(against_total = sum(number))
# 
# 
# sum_voters <- total_voters %>% 
#   left_join(gov_voters) %>% 
#   left_join(reject_voters) %>% 
#   left_join(against_voters) %>% 
#   mutate(gov_ratio = gov_total/total,
#          reject_ratio = reject_total/total,
#          against_ratio = against_total/total)
# 
# df_18_24_people_diff <- sum_voters %>% 
# group_by(en_country) %>% 
#   arrange(en_country,year) %>% 
#   filter(year!=2020) %>% 
#   mutate(gov_total_diff =gov_total - lag(gov_total),
#          against_total_diff = against_total - lag(against_total),
#          reject_total_diff = reject_total - lag(reject_total),
#          ag_rej_diff = against_total_diff + reject_total_diff,
#          gov_ratio= gov_total/total,
#          gov_flag = ifelse(gov_ratio>0.5,"Y","N")) %>% 
#   select(year,en_country,gov_total_diff,reject_total,against_total_diff,ag_rej_diff,gov_flag) %>% 
#   filter(year==2024) %>% 
#   mutate(mymean = mean(c(gov_total_diff,ag_rej_diff))) %>% 
#   arrange(mymean) %>% 
#   mutate(en_country = factor(en_country,en_country))
# 
# 
# df_12_18_people_diff <- sum_voters %>% 
# group_by(en_country) %>% 
#   arrange(en_country,year) %>% 
#   filter(year!=2020) %>% 
#   mutate(gov_total_diff =gov_total - lag(gov_total),
#          against_total_diff = against_total - lag(against_total),
#          reject_total_diff = reject_total - lag(reject_total),
#          ag_rej_diff = against_total_diff + reject_total_diff,
#          gov_ratio= gov_total/total,
#          gov_flag = ifelse(gov_ratio>0.5,"Y","N")) %>% 
#   select(year,en_country,gov_total_diff,reject_total,against_total_diff,ag_rej_diff,gov_flag) %>% 
#   filter(year==2018) %>% 
#   mutate(mymean = mean(c(gov_total_diff,ag_rej_diff))) %>% 
#   arrange(mymean) %>% 
#   mutate(en_country = factor(en_country,en_country))
# 
# threshold <- 500
# #filter(df_18_24_people_diff, mymean > threshold || mymean < -threshold) %>% write.csv('docs/out/diff_18-24.csv',row.names = F)
# 
# g1 <- ggplot(filter(df_18_24_people_diff, mymean > threshold || mymean < -threshold)) +
#   geom_segment( aes(x=reorder(en_country,mymean), xend=en_country, y=gov_total_diff, yend=ag_rej_diff,color=gov_flag),
#                 linewidth=1) +
#   geom_point( aes(x=reorder(en_country,mymean), y=gov_total_diff,
#                   text=paste0(en_country,'<br>gov votes diff 18-24: ',gov_total_diff)), color='brown', size=3 ) +
#   geom_point( aes(x=reorder(en_country,mymean), y=ag_rej_diff,
#                   text=paste0(en_country,'<br>anti gov diff 18-24: ',ag_rej_diff)), color='#0084D7', size=2 ) +
#   coord_flip()+
#   scale_color_manual(values = c('#0084D7','brown'))+
#   theme_minimal_vgrid(font_size = 10)+
#   theme(
#     legend.position = "none",
#   ) +
#   xlab("") +
#   ylab("Difference in people")+
#   labs(title="Difference in votes 2018-2024")
# 
# ggplotly(g1,tooltip = 'text')
# 
# threshold2 <- 200
# g2 <- ggplot(filter(df_12_18_people_diff, mymean > threshold2 || mymean < -threshold2)) +
#   geom_segment( aes(x=reorder(en_country,mymean), xend=en_country, y=gov_total_diff, yend=ag_rej_diff,color=gov_flag),
#                 linewidth=1) +
#   geom_point( aes(x=reorder(en_country,mymean), y=gov_total_diff,
#                   text=paste0(en_country,'<br>gov votes diff 12-18: ',gov_total_diff)), color='brown', size=3 ) +
#   geom_point( aes(x=reorder(en_country,mymean), y=ag_rej_diff,
#                   text=paste0(en_country,'<br>anti gov diff 12-18: ',ag_rej_diff)), color='#0084D7', size=2 ) +
#   coord_flip()+
#   scale_color_manual(values = c('brown','#0084D7'))+
#   theme_minimal_vgrid(font_size = 10)+
#   theme(
#     legend.position = "none",
#   ) +
#   xlab("") +
#   ylab("Difference in people")+
#   labs(title="Difference in votes 2012-2018")
# 
# ggplotly(g2,tooltip = 'text')
# 
# #subplot(g1,g2,nrows = 1) 
```

На выборах 2024 людей поддерживающих Путина пришло меньше чем в 2018, а людей против, здесь учтены все другие кандидаты и порча бюллетеней больше. Забавно, что на Кипре, в Никосии, судя по количеству они подрисовали и протестные голоса, т.к. их количество выросло на 7149 человек.

```{=html}
<iframe title="Russian president elections 2024" aria-label="Dot Plot" id="datawrapper-chart-c5FGA" src="https://datawrapper.dwcdn.net/c5FGA/2/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="767" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
</script>
```
Тот факт, что в 2018 не было участков где Путин получил меньше 50% объясняется тем, что на выборы 18-го пришло больше избирателей за Путина и меньше против, по сравнению с 2012 годом.

```{=html}
<iframe title="Russian president elections 2018" aria-label="Dot Plot" id="datawrapper-chart-azTHQ" src="https://datawrapper.dwcdn.net/azTHQ/1/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="561" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
</script>
```
